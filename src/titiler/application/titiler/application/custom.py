"""TiTiler demo custon dependencies."""

import json
from enum import Enum
from typing import Dict, Optional

import morecantile
from morecantile import tms
from morecantile.models import TileMatrixSet
from rasterio.crs import CRS
from rio_tiler.colormap import cmap, parse_color

from fastapi import HTTPException, Query

from starlette.templating import Jinja2Templates

try:
    from importlib.resources import files as resources_files  # type: ignore
except ImportError:
    # Try backported to PY<39 `importlib_resources`.
    from importlib_resources import files as resources_files  # type: ignore


templates = Jinja2Templates(directory=str(resources_files(__package__) / "templates"))


# colors from https://daac.ornl.gov/ABOVE/guides/Annual_Landcover_ABoVE.html
above_cmap = {
    1: [58, 102, 24, 255],  # Evergreen Forest
    2: [100, 177, 41, 255],  # Deciduous Forest
    3: [177, 177, 41, 255],  # Shrubland
    4: [221, 203, 154, 255],  # Herbaceous
    5: [218, 203, 47, 255],  # Sparely Vegetated
    6: [177, 177, 177, 255],  # Barren
    7: [175, 255, 205, 255],  # Fen
    8: [239, 255, 192, 255],  # Bog
    9: [144, 255, 255, 255],  # Shallows/Littoral
    10: [29, 0, 250, 255],  # Water
}
cmap = cmap.register({"above": above_cmap})

# custom color scale for EO Lake Watch project
# locked 0-9 as the same blue color to scale our clamped data
lakewatch_cmap = {
    0: [0, 0, 200, 255],
    1: [0, 0, 200, 255],
    2: [0, 0, 200, 255],
    3: [0, 0, 200, 255],
    4: [0, 0, 200, 255],
    5: [0, 0, 200, 255],
    6: [0, 0, 200, 255],
    7: [0, 0, 200, 255],
    8: [0, 0, 200, 255],
    9: [0, 0, 200, 255],
    10: [24, 132, 160, 255],
    11: [24, 134, 159, 255],
    12: [23, 136, 159, 255],
    13: [23, 138, 158, 255],
    14: [22, 140, 157, 255],
    15: [22, 142, 157, 255],
    16: [22, 144, 156, 255],
    17: [21, 146, 155, 255],
    18: [21, 148, 155, 255],
    19: [20, 150, 154, 255],
    20: [20, 152, 153, 255],
    21: [20, 154, 153, 255],
    22: [19, 156, 152, 255],
    23: [19, 158, 151, 255],
    24: [18, 160, 151, 255],
    25: [18, 162, 150, 255],
    26: [18, 164, 149, 255],
    27: [17, 166, 149, 255],
    28: [17, 168, 148, 255],
    29: [17, 170, 147, 255],
    30: [16, 172, 147, 255],
    31: [16, 174, 146, 255],
    32: [15, 176, 145, 255],
    33: [15, 178, 145, 255],
    34: [15, 180, 144, 255],
    35: [14, 182, 143, 255],
    36: [14, 184, 143, 255],
    37: [13, 186, 142, 255],
    38: [13, 188, 141, 255],
    39: [13, 190, 141, 255],
    40: [12, 192, 140, 255],
    41: [12, 195, 139, 255],
    42: [11, 197, 138, 255],
    43: [11, 199, 138, 255],
    44: [11, 201, 137, 255],
    45: [10, 203, 136, 255],
    46: [10, 205, 136, 255],
    47: [9, 207, 135, 255],
    48: [9, 209, 134, 255],
    49: [9, 211, 134, 255],
    50: [8, 213, 133, 255],
    51: [8, 215, 132, 255],
    52: [7, 217, 132, 255],
    53: [7, 219, 131, 255],
    54: [7, 221, 130, 255],
    55: [6, 223, 130, 255],
    56: [6, 225, 129, 255],
    57: [6, 227, 128, 255],
    58: [5, 229, 128, 255],
    59: [5, 231, 127, 255],
    60: [4, 233, 126, 255],
    61: [4, 235, 126, 255],
    62: [4, 237, 125, 255],
    63: [3, 239, 124, 255],
    64: [3, 241, 124, 255],
    65: [2, 243, 123, 255],
    66: [2, 245, 122, 255],
    67: [2, 247, 122, 255],
    68: [1, 249, 121, 255],
    69: [1, 251, 120, 255],
    70: [0, 253, 120, 255],
    71: [0, 255, 119, 255],
    72: [4, 255, 117, 255],
    73: [8, 254, 115, 255],
    74: [13, 254, 113, 255],
    75: [17, 254, 111, 255],
    76: [21, 253, 109, 255],
    77: [25, 253, 107, 255],
    78: [29, 253, 105, 255],
    79: [33, 252, 103, 255],
    80: [38, 252, 101, 255],
    81: [42, 252, 99, 255],
    82: [46, 251, 98, 255],
    83: [50, 251, 96, 255],
    84: [54, 251, 94, 255],
    85: [59, 250, 92, 255],
    86: [63, 250, 90, 255],
    87: [67, 250, 88, 255],
    88: [71, 249, 86, 255],
    89: [75, 249, 84, 255],
    90: [79, 249, 82, 255],
    91: [84, 248, 80, 255],
    92: [88, 248, 78, 255],
    93: [92, 248, 76, 255],
    94: [96, 247, 74, 255],
    95: [100, 247, 72, 255],
    96: [105, 247, 70, 255],
    97: [109, 246, 68, 255],
    98: [113, 246, 66, 255],
    99: [117, 246, 64, 255],
    100: [121, 245, 62, 255],
    101: [125, 245, 60, 255],
    102: [130, 245, 59, 255],
    103: [134, 245, 57, 255],
    104: [138, 244, 55, 255],
    105: [142, 244, 53, 255],
    106: [146, 244, 51, 255],
    107: [150, 243, 49, 255],
    108: [155, 243, 47, 255],
    109: [159, 243, 45, 255],
    110: [163, 242, 43, 255],
    111: [167, 242, 41, 255],
    112: [171, 242, 39, 255],
    113: [176, 241, 37, 255],
    114: [180, 241, 35, 255],
    115: [184, 241, 33, 255],
    116: [188, 240, 31, 255],
    117: [192, 240, 29, 255],
    118: [196, 240, 27, 255],
    119: [201, 239, 25, 255],
    120: [205, 239, 23, 255],
    121: [209, 239, 21, 255],
    122: [213, 238, 20, 255],
    123: [217, 238, 18, 255],
    124: [222, 238, 16, 255],
    125: [226, 237, 14, 255],
    126: [230, 237, 12, 255],
    127: [234, 237, 10, 255],
    128: [238, 236, 8, 255],
    129: [242, 236, 6, 255],
    130: [247, 236, 4, 255],
    131: [251, 235, 2, 255],
    132: [255, 235, 0, 255],
    133: [254, 231, 0, 255],
    134: [254, 227, 0, 255],
    135: [253, 223, 0, 255],
    136: [252, 220, 0, 255],
    137: [252, 216, 0, 255],
    138: [251, 212, 0, 255],
    139: [250, 208, 0, 255],
    140: [250, 204, 0, 255],
    141: [249, 200, 0, 255],
    142: [248, 196, 0, 255],
    143: [248, 193, 0, 255],
    144: [247, 189, 0, 255],
    145: [246, 185, 0, 255],
    146: [246, 181, 0, 255],
    147: [245, 177, 0, 255],
    148: [245, 173, 0, 255],
    149: [244, 170, 0, 255],
    150: [243, 166, 0, 255],
    151: [243, 162, 0, 255],
    152: [242, 158, 0, 255],
    153: [241, 154, 0, 255],
    154: [241, 150, 0, 255],
    155: [240, 146, 0, 255],
    156: [239, 143, 0, 255],
    157: [239, 139, 0, 255],
    158: [238, 135, 0, 255],
    159: [237, 131, 0, 255],
    160: [237, 127, 0, 255],
    161: [236, 123, 0, 255],
    162: [235, 119, 0, 255],
    163: [235, 116, 0, 255],
    164: [234, 112, 0, 255],
    165: [233, 108, 0, 255],
    166: [233, 104, 0, 255],
    167: [232, 100, 0, 255],
    168: [231, 96, 0, 255],
    169: [231, 92, 0, 255],
    170: [230, 89, 0, 255],
    171: [229, 85, 0, 255],
    172: [229, 81, 0, 255],
    173: [228, 77, 0, 255],
    174: [227, 73, 0, 255],
    175: [227, 69, 0, 255],
    176: [226, 65, 0, 255],
    177: [225, 62, 0, 255],
    178: [225, 58, 0, 255],
    179: [224, 54, 0, 255],
    180: [224, 50, 0, 255],
    181: [223, 46, 0, 255],
    182: [222, 42, 0, 255],
    183: [222, 39, 0, 255],
    184: [221, 35, 0, 255],
    185: [220, 31, 0, 255],
    186: [220, 27, 0, 255],
    187: [219, 23, 0, 255],
    188: [218, 19, 0, 255],
    189: [218, 15, 0, 255],
    190: [217, 12, 0, 255],
    191: [216, 8, 0, 255],
    192: [216, 4, 0, 255],
    193: [215, 0, 0, 255],
    194: [213, 0, 0, 255],
    195: [212, 0, 0, 255],
    196: [210, 0, 0, 255],
    197: [208, 0, 0, 255],
    198: [207, 0, 0, 255],
    199: [205, 0, 0, 255],
    200: [204, 0, 0, 255],
    201: [202, 0, 0, 255],
    202: [200, 0, 0, 255],
    203: [199, 0, 0, 255],
    204: [197, 0, 0, 255],
    205: [195, 0, 0, 255],
    206: [194, 0, 0, 255],
    207: [192, 0, 0, 255],
    208: [190, 0, 0, 255],
    209: [189, 0, 0, 255],
    210: [187, 0, 0, 255],
    211: [185, 0, 0, 255],
    212: [184, 0, 0, 255],
    213: [182, 0, 0, 255],
    214: [181, 0, 0, 255],
    215: [179, 0, 0, 255],
    216: [177, 0, 0, 255],
    217: [176, 0, 0, 255],
    218: [174, 0, 0, 255],
    219: [172, 0, 0, 255],
    220: [171, 0, 0, 255],
    221: [169, 0, 0, 255],
    222: [167, 0, 0, 255],
    223: [166, 0, 0, 255],
    224: [164, 0, 0, 255],
    225: [163, 0, 0, 255],
    226: [161, 0, 0, 255],
    227: [159, 0, 0, 255],
    228: [158, 0, 0, 255],
    229: [156, 0, 0, 255],
    230: [154, 0, 0, 255],
    231: [153, 0, 0, 255],
    232: [151, 0, 0, 255],
    233: [149, 0, 0, 255],
    234: [148, 0, 0, 255],
    235: [146, 0, 0, 255],
    236: [145, 0, 0, 255],
    237: [143, 0, 0, 255],
    238: [141, 0, 0, 255],
    239: [140, 0, 0, 255],
    240: [138, 0, 0, 255],
    241: [136, 0, 0, 255],
    242: [135, 0, 0, 255],
    243: [133, 0, 0, 255],
    244: [131, 0, 0, 255],
    245: [130, 0, 0, 255],
    246: [128, 0, 0, 255],
    247: [126, 0, 0, 255],
    248: [125, 0, 0, 255],
    249: [123, 0, 0, 255],
    250: [122, 0, 0, 255],
    251: [120, 0, 0, 255],
    252: [118, 0, 0, 255],
    253: [117, 0, 0, 255],
    254: [115, 0, 0, 255],
    255: [115, 0, 0, 255],
}

cmap = cmap.register({"lakewatch": lakewatch_cmap})

ColorMapName = Enum(  # type: ignore
    "ColorMapName", [(a, a) for a in sorted(cmap.list())]
)

# CUSTOM TMS for EPSG:3413
EPSG3413 = morecantile.TileMatrixSet.custom(
    [-4194300, -4194300, 4194300, 4194300],
    CRS.from_epsg(3413),
    identifier="EPSG3413",
    matrix_scale=[2, 2],
)

# CUSTOM TMS for EPSG:6933
# info from https://epsg.io/6933
EPSG6933 = morecantile.TileMatrixSet.custom(
    [-17357881.81713629, -7324184.56362408, 17357881.81713629, 7324184.56362408],
    CRS.from_epsg(6933),
    identifier="EPSG6933",
    matrix_scale=[1, 1],
)
tms = tms.register([EPSG3413, EPSG6933])

TileMatrixSetName = Enum(  # type: ignore
    "TileMatrixSetName", [(a, a) for a in sorted(tms.list())]
)


def ColorMapParams(
    colormap_name: ColorMapName = Query(None, description="Colormap name"),
    colormap: str = Query(None, description="JSON encoded custom Colormap"),
) -> Optional[Dict]:
    """Colormap Dependency."""
    if colormap_name:
        return cmap.get(colormap_name.value)

    if colormap:
        try:
            return json.loads(
                colormap,
                object_hook=lambda x: {int(k): parse_color(v) for k, v in x.items()},
            )
        except json.JSONDecodeError:
            raise HTTPException(
                status_code=400, detail="Could not parse the colormap value."
            )

    return None


def TMSParams(
    TileMatrixSetId: TileMatrixSetName = Query(
        TileMatrixSetName.WebMercatorQuad,  # type: ignore
        description="TileMatrixSet Name (default: 'WebMercatorQuad')",
    )
) -> TileMatrixSet:
    """TileMatrixSet Dependency."""
    return tms.get(TileMatrixSetId.name)
